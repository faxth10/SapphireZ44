<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Health Sensor App - Real-time Colors</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1976d2;
      --success: #4caf50;
      --warning: #fbc02d;
      --danger: #f44336;
      --bg: #f5f7fa;
    }
    body { font-family: "Kanit", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
    .container { max-width: 500px; margin: auto; background: #fff; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); transition: 0.3s; }
    
    /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏µ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πà‡∏≤ */
    .bg-normal { background: #fff; }
    .bg-green { background: #dcfce7 !important; }
    .bg-yellow { background: #fef3c7 !important; }
    .bg-red { background: #fee2e2 !important; }

    h1 { text-align: center; color: var(--primary); font-size: 22px; margin-bottom: 5px; }
    .sub-title { text-align: center; color: #94a3b8; font-size: 14px; margin-bottom: 25px; }
    .round-tag { background: rgba(25, 118, 210, 0.1); color: var(--primary); padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 14px; display: inline-block; margin-bottom: 15px; }
    
    #status-display { padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 20px; }
    .value-display { font-size: 64px; font-weight: 700; line-height: 1; margin: 10px 0; }
    .timer-display { font-size: 18px; font-weight: 500; color: #475569; margin-top: 5px; }
    canvas { width: 100%; height: 80px; border-radius: 15px; background: rgba(255,255,255,0.5); margin: 15px 0; border: 1px solid rgba(0,0,0,0.05); }

    button { width: 100%; padding: 15px; border-radius: 15px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-bottom: 10px; }
    .btn-start { background: var(--primary); color: white; }
    .btn-stop { background: var(--danger); color: white; }
    .btn-outline { background: rgba(0,0,0,0.05); color: #64748b; }
    
    .input-group { margin-bottom: 15px; text-align: left; }
    input, select { width: 100%; padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 12px; box-sizing: border-box; font-family: 'Kanit'; font-size: 16px; }
    .hidden { display: none; }
    hr { border: 0; border-top: 1px solid rgba(0,0,0,0.1); margin: 15px 0; }
  </style>
</head>
<body>

<div class="container" id="page1">
    <center><img width="80px" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR6dh1EFfBVQyfw8WKTTaaqjwzfRXWzLyL6yw&s" alt="Logo"></center>
    <h1>Health Sensor App</h1>
    <div class="sub-title">‡∏ä‡∏°‡∏£‡∏°‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏ô‡∏ô‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏™‡∏£‡∏£‡∏Ñ‡πå</div>
    <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label><input id="name" type="text" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠"></div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div class="input-group"><label>‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label><input id="age" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15"></div>
        <div class="input-group"><label>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label><input id="height" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 165"></div>
    </div>
    <div class="input-group"><label>‡πÄ‡∏û‡∏®</label><select id="gender"><option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option><option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
    <button class="btn-start" onclick="initMicAndNextPage()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö üöÄ</button>
</div>

<div class="container" id="page2" style="text-align: center; display: none;">
    <div class="round-tag">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="roundNo">1</span> / 5</div>
    <div id="status-display">
        <div id="status-text" style="font-size: 18px; font-weight: 600;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏õ‡πà‡∏≤...</div>
        <div class="value-display"><span id="val-num">0</span> <span style="font-size:16px">L/min</span></div>
        <div class="timer-display">‚è± ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πà‡∏≤: <span id="current-timer">0.00</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
    </div>
    <canvas id="graphCanvas"></canvas>
    <button id="startBtn" class="btn-start" onclick="startTestRound()">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πà‡∏≤</button>
    <button id="stopBtn" class="btn-stop hidden" onclick="stopTestRound()">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î</button>
</div>

<div class="container hidden" id="page3" style="text-align: center;">
    <h1>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</h1>
    <div id="summary-data" style="background:rgba(0,0,0,0.02); padding:20px; border-radius:20px; margin:20px 0; text-align:left; font-size: 15px;"></div>
    
    <div id="final-card" style="padding:25px; border-radius:20px; margin-bottom:20px; border: 1px solid #eee;">
        <div style="font-size: 14px; opacity: 0.8;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: <span id="final-avg-val">0</span> L/min</div>
        <div id="final-avg-duration" style="font-size:14px; opacity: 0.8; margin-bottom:10px;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: 0.00 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
        <div id="final-status" style="font-size:24px; font-weight:700; border-top: 1px solid rgba(0,0,0,0.1); padding-top:15px; margin-top:10px;"></div>
    </div>

    <button class="btn-start" onclick="window.print()">üíæ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (PDF)</button>
    <button class="btn-outline" onclick="location.reload()">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
</div>

<script>
    let user = {}, round = 0, allRounds = [], allDurations = [], isMeasuring = false;
    let audioContext, analyser, microphone, dataArray, animationId, globalStream;
    let silenceTimer, currentRoundMax = 0, startTime = 0, roundDuration = 0;

    function getPredictedPEFR(age, height, gender) {
        let base = (gender === '‡∏ä‡∏≤‡∏¢') ? ((height - 100) * 5 + 100) : ((height - 100) * 4 + 50);
        let result = base - (age * 0.5); 
        return Math.max(200, Math.round(result));
    }

    async function initMicAndNextPage() {
        const n = document.getElementById('name').value;
        const a = document.getElementById('age').value;
        const h = document.getElementById('height').value;
        const g = document.getElementById('gender').value;
        if (!n || !a || !h || !g) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
        try {
            globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            user = { name: n, age: parseInt(a), height: parseInt(h), gender: g };
            user.predicted = getPredictedPEFR(user.age, user.height, user.gender);
            document.getElementById('page1').style.display = 'none';
            document.getElementById('page2').style.display = 'block';
        } catch (e) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô'); }
    }

    async function startTestRound() {
        if (round >= 5) return;
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(globalStream);
            analyser.fftSize = 512;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            microphone.connect(analyser);
        }
        if (audioContext.state === 'suspended') await audioContext.resume();
        round++;
        currentRoundMax = 0; roundDuration = 0; startTime = 0;
        document.getElementById('roundNo').textContent = round;
        document.getElementById('startBtn').classList.add('hidden');
        document.getElementById('stopBtn').classList.remove('hidden');
        document.getElementById('page2').className = "container bg-normal";
        isMeasuring = true;
        runLoop();
    }

    function runLoop() {
        const canvas = document.getElementById('graphCanvas');
        const ctx = canvas.getContext('2d');
        const pageContainer = document.getElementById('page2');
        const statusText = document.getElementById('status-text');

        function draw() {
            if (!isMeasuring) return;
            analyser.getByteFrequencyData(dataArray);
            let avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
            let pefr = Math.min(800, avg * 8.5); 
            
            if (pefr > 40) {
                if (startTime === 0) startTime = Date.now();
                roundDuration = (Date.now() - startTime) / 1000;
                document.getElementById('current-timer').textContent = roundDuration.toFixed(2);
                if (pefr > currentRoundMax) currentRoundMax = pefr;
                
                // Real-time Color Logic
                let currentRatio = (pefr / user.predicted) * 100;
                if (currentRatio >= 55) {
                    pageContainer.className = "container bg-green";
                    statusText.textContent = "‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å (‡∏õ‡∏Å‡∏ï‡∏¥) ‚úÖ";
                } else if (currentRatio >= 35) {
                    pageContainer.className = "container bg-yellow";
                    statusText.textContent = "‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á ‚ö†Ô∏è";
                } else {
                    pageContainer.className = "container bg-red";
                    statusText.textContent = "‡πÄ‡∏ö‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‚ùå";
                }

                clearTimeout(silenceTimer);
                silenceTimer = setTimeout(stopTestRound, 1500);
            }

            document.getElementById('val-num').textContent = Math.round(pefr);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(25, 118, 210, 0.8)';
            ctx.fillRect(0, canvas.height, canvas.width, -(pefr/800 * canvas.height));
            animationId = requestAnimationFrame(draw);
        }
        draw();
    }

    function stopTestRound() {
        isMeasuring = false;
        clearTimeout(silenceTimer);
        cancelAnimationFrame(animationId);
        allRounds.push(currentRoundMax);
        allDurations.push(roundDuration);
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('page2').className = "container bg-normal";
        document.getElementById('status-text').textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà " + round + " ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        if (round >= 5) setTimeout(showFinal, 800);
    }

    function showFinal() {
        document.getElementById('page2').style.display = 'none';
        document.getElementById('page3').classList.remove('hidden');
        const avgPefr = allRounds.reduce((a, b) => a + b, 0) / allRounds.length;
        const avgDur = allDurations.reduce((a, b) => a + b, 0) / allDurations.length;
        const ratio = (avgPefr / user.predicted) * 100;

        document.getElementById('summary-data').innerHTML = `
            <b>‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</b> ${user.name}<br>
            <b>‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô:</b> ${user.predicted} L/min<br>
            <b>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ:</b> ${ratio.toFixed(1)}% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô<br><hr>
            ${allRounds.map((v, i) => `‡∏£‡∏≠‡∏ö ${i+1}: <b>${Math.round(v)}</b> L/min (${allDurations[i].toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`).join('<br>')}
        `;

        document.getElementById('final-avg-val').textContent = Math.round(avgPefr);
        document.getElementById('final-avg-duration').textContent = `‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${avgDur.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        
        const st = document.getElementById('final-status');
        const card = document.getElementById('final-card');

        if (ratio >= 55) {
            st.textContent = "‡∏õ‡∏Å‡∏ï‡∏¥ (Green Zone) üü¢";
            card.style.background = "#dcfce7"; card.style.color = "#15803d";
        } else if (ratio >= 35) {
            st.textContent = "‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á (Yellow Zone) üü°";
            card.style.background = "#fef3c7"; card.style.color = "#b45309";
        } else {
            st.textContent = "‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå (Red Zone) üî¥";
            card.style.background = "#fee2e2"; card.style.color = "#b91c1c";
        }
    }
</script>
</body>
</html>