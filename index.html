<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Health Sensor App - Non-Sa-Ad Phittayasan</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1976d2;
      --success: #4caf50;
      --warning: #fbc02d;
      --danger: #f44336;
      --bg: #f5f7fa;
    }
    body { font-family: "Kanit", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
    .container { max-width: 500px; margin: auto; background: #fff; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    h1 { text-align: center; color: var(--primary); font-size: 22px; margin-bottom: 5px; }
    .sub-title { text-align: center; color: #94a3b8; font-size: 14px; margin-bottom: 25px; }
    .round-tag { background: #e0f2fe; color: var(--primary); padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 14px; display: inline-block; margin-bottom: 15px; }
    
    #status-display { padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 20px; transition: 0.3s; }
    .status-idle { background: #f8fafc; color: #64748b; border: 2px dashed #e2e8f0; }
    .status-low { background: #fff9c4; color: #b45309; border: 2px solid #fef3c7; }
    .status-good { background: #f0fdf4; color: #15803d; border: 2px solid #dcfce7; }
    .status-high { background: #fef2f2; color: #b91c1c; border: 2px solid #fee2e2; }

    .value-display { font-size: 56px; font-weight: 700; line-height: 1; margin: 10px 0; }
    canvas { width: 100%; height: 100px; border-radius: 15px; background: #fdfdfd; margin: 15px 0; border: 1px solid #f0f0f0; }

    .zone-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
    .zone-card { padding: 10px; border-radius: 12px; text-align: center; font-size: 11px; font-weight: 500; opacity: 0.4; transition: 0.3s; }
    .zone-card.active { opacity: 1; transform: scale(1.05); }
    .z-red { background: #fee2e2; color: #b91c1c; }
    .z-green { background: #dcfce7; color: #15803d; }
    .z-yellow { background: #fef3c7; color: #b45309; }

    button { width: 100%; padding: 15px; border-radius: 15px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-bottom: 10px; }
    .btn-start { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(25, 118, 210, 0.2); }
    .btn-excel { background: #2e7d32; color: white; }
    .btn-stop { background: var(--danger); color: white; }
    .btn-outline { background: #f1f5f9; color: #64748b; }
    
    .input-group { margin-bottom: 15px; text-align: left; }
    input, select { width: 100%; padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 12px; box-sizing: border-box; font-family: 'Kanit', sans-serif; }
    .hidden { display: none; }
    hr { border: 0; border-top: 1px solid #eee; margin: 15px 0; }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå */
    @media print {
      .btn-start, .btn-excel, .btn-outline, .btn-stop { display: none; }
      body { background: white; padding: 0; }
      .container { box-shadow: none; border: 1px solid #eee; }
    }
  </style>
</head>
<body>

<div class="container" id="page1">
    <center><img width="80px" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR6dh1EFfBVQyfw8WKTTaaqjwzfRXWzLyL6yw&s" alt="Logo"></center>
    <h1>Health Sensor App</h1>
    <div class="sub-title">‡∏ä‡∏°‡∏£‡∏°‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏ô‡∏ô‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏™‡∏£‡∏£‡∏Ñ‡πå</div>
    <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label><input id="name" type="text" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠"></div>
    <div class="input-group"><label>‡∏≠‡∏≤‡∏¢‡∏∏</label><input id="age" type="number" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏¢‡∏∏"></div>
    <div class="input-group"><label>‡πÄ‡∏û‡∏®</label><select id="gender"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®</option><option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option><option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
    <button class="btn-start" onclick="initMicAndNextPage()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö üöÄ</button>
</div>

<div class="container hidden" id="page2" style="text-align: center;">
    <div class="round-tag">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="roundNo">1</span> / 5</div>
    <div id="status-display" class="status-idle">
        <div id="status-text" style="font-size: 18px; font-weight: 600;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
        <div class="value-display"><span id="val-num">0</span> <span style="font-size:16px">L/min</span></div>
    </div>
    <div class="zone-container">
        <div id="z-low" class="zone-card z-yellow">‡πÄ‡∏ö‡∏≤‡πÑ‡∏õ<br>< 350</div>
        <div id="z-good" class="zone-card z-green">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏µ<br>350-450</div>
        <div id="z-high" class="zone-card z-red">‡πÅ‡∏£‡∏á‡πÑ‡∏õ<br>> 450</div>
    </div>
    <canvas id="graphCanvas"></canvas>
    <button id="startBtn" class="btn-start" onclick="startTestRound()">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πà‡∏≤‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</button>
    <button id="stopBtn" class="btn-stop hidden" onclick="stopTestRound()">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î</button>
    <button class="btn-outline" style="font-size: 14px;" onclick="location.reload()">üîô ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
</div>

<div class="container hidden" id="page3" style="text-align: center;">
    <h1>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h1>
    <div id="summary-data" style="background:#f8fafc; padding:20px; border-radius:20px; margin:20px 0; text-align:left; font-size: 15px;"></div>
    
    <div id="final-card" style="padding:25px; border-radius:20px; margin-bottom:20px; border: 1px solid #eee;">
        <div id="final-avg" style="font-size:48px; font-weight:700;">0</div>
        <div id="final-status" style="font-size:18px; font-weight:600; margin-top: 5px;"></div>
    </div>

    <button class="btn-excel" onclick="exportToExcel()">üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (.csv)</button>
    <button class="btn-start" onclick="window.print()">üíæ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (PDF)</button>
    <button class="btn-outline" onclick="location.reload()">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
</div>

<script>
    let user = {}, round = 0, allRounds = [], isMeasuring = false;
    let audioContext, analyser, microphone, dataArray, animationId, globalStream;
    let silenceTimer, currentRoundMax = 0;

    async function initMicAndNextPage() {
        const n = document.getElementById('name').value;
        const a = document.getElementById('age').value;
        const g = document.getElementById('gender').value;
        if (!n || !a || !g) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
        
        try {
            // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡∏Ñ‡πå (‡∏ö‡∏ô GitHub Pages ‡∏à‡∏∞‡πÉ‡∏ä‡πâ HTTPS ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ)
            globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            user = { name: n, age: a, gender: g };
            document.getElementById('page1').classList.add('hidden');
            document.getElementById('page2').classList.remove('hidden');
        } catch (e) { 
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô https ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå'); 
            console.error(e);
        }
    }

    async function startTestRound() {
        if (round >= 5) return;
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(globalStream);
            analyser.fftSize = 512;
            analyser.smoothingTimeConstant = 0.8;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            microphone.connect(analyser);
        }
        if (audioContext.state === 'suspended') await audioContext.resume();
        
        round++;
        currentRoundMax = 0;
        document.getElementById('roundNo').textContent = round;
        document.getElementById('startBtn').classList.add('hidden');
        document.getElementById('stopBtn').classList.remove('hidden');
        isMeasuring = true;
        runLoop();
    }

    function runLoop() {
        const canvas = document.getElementById('graphCanvas');
        const ctx = canvas.getContext('2d');
        const statusDisplay = document.getElementById('status-display');
        const statusText = document.getElementById('status-text');

        function draw() {
            if (!isMeasuring) return;
            analyser.getByteFrequencyData(dataArray);
            let avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
            
            // ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏•‡∏°
            let pefr = Math.min(800, avg * 8.5); 
            if (pefr > currentRoundMax) currentRoundMax = pefr;

            // Auto-stop: ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏õ‡πà‡∏≤‡∏ô‡∏≤‡∏ô 1.7 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            if (pefr > 40) {
                clearTimeout(silenceTimer);
                silenceTimer = setTimeout(stopTestRound, 1700);
            }

            document.getElementById('val-num').textContent = Math.round(pefr);
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á UI ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á
            document.querySelectorAll('.zone-card').forEach(c => c.classList.remove('active'));
            if (pefr > 450) {
                statusDisplay.className = "status-high"; statusText.textContent = "‡πÅ‡∏£‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ!";
                document.getElementById('z-high').classList.add('active');
            } else if (pefr >= 350) {
                statusDisplay.className = "status-good"; statusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏µ";
                document.getElementById('z-good').classList.add('active');
            } else if (pefr > 40) {
                statusDisplay.className = "status-low"; statusText.textContent = "‡πÄ‡∏ö‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ";
                document.getElementById('z-low').classList.add('active');
            } else {
                statusDisplay.className = "status-idle"; statusText.textContent = "‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏•‡∏°‡πÄ‡∏õ‡πà‡∏≤...";
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = pefr > 450 ? '#f44336' : (pefr >= 350 ? '#4caf50' : '#fbc02d');
            ctx.fillRect(0, canvas.height, canvas.width, -(pefr/800 * canvas.height));
            animationId = requestAnimationFrame(draw);
        }
        draw();
    }

    function stopTestRound() {
        if (!isMeasuring) return;
        isMeasuring = false;
        clearTimeout(silenceTimer);
        cancelAnimationFrame(animationId);
        allRounds.push(currentRoundMax);
        
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('status-display').className = "status-idle";
        document.getElementById('status-text').textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà " + round + " ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ";
        
        if (round >= 5) setTimeout(showFinal, 800);
    }

    function showFinal() {
        document.getElementById('page2').classList.add('hidden');
        document.getElementById('page3').classList.remove('hidden');
        const avg = allRounds.reduce((a, b) => a + b, 0) / 5;
        
        document.getElementById('summary-data').innerHTML = `
            <b>‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</b> ${user.name}<br>
            <b>‡∏≠‡∏≤‡∏¢‡∏∏:</b> ${user.age} | <b>‡πÄ‡∏û‡∏®:</b> ${user.gender}<br><hr>
            ${allRounds.map((v, i) => `‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${i+1}: <b>${Math.round(v)}</b> L/min`).join('<br>')}
        `;
        document.getElementById('final-avg').textContent = Math.round(avg) + " L/min";
        
        const st = document.getElementById('final-status');
        const card = document.getElementById('final-card');
        if(avg >= 400) { st.textContent = "‡πÄ‡∏Å‡∏ì‡∏ë‡πå: ‡∏î‡∏µ‡∏°‡∏≤‡∏Å üåü"; card.style.background = "#dcfce7"; card.style.color = "#15803d"; }
        else if(avg >= 300) { st.textContent = "‡πÄ‡∏Å‡∏ì‡∏ë‡πå: ‡∏õ‡∏Å‡∏ï‡∏¥ ‚úÖ"; card.style.background = "#fef3c7"; card.style.color = "#b45309"; }
        else { st.textContent = "‡πÄ‡∏Å‡∏ì‡∏ë‡πå: ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á ‚ö†Ô∏è"; card.style.background = "#fee2e2"; card.style.color = "#b91c1c"; }
    }

    function exportToExcel() {
        const avg = allRounds.reduce((a, b) => a + b, 0) / 5;
        let status = avg >= 400 ? "‡∏î‡∏µ‡∏°‡∏≤‡∏Å" : (avg >= 300 ? "‡∏õ‡∏Å‡∏ï‡∏¥" : "‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á");
        
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
        csvContent += "‡∏ä‡∏∑‡πà‡∏≠,‡∏≠‡∏≤‡∏¢‡∏∏,‡πÄ‡∏û‡∏®,‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1,‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2,‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 3,‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 4,‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 5,‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢,‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•\n";
        csvContent += `${user.name},${user.age},${user.gender},${allRounds.map(v=>Math.round(v)).join(",")},${Math.round(avg)},${status}\n`;
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Health_Report_${user.name}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>