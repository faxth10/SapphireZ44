<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Health Sensor App - Professional Logic</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1976d2;
      --success: #4caf50;
      --warning: #fbc02d;
      --danger: #f44336;
      --bg: #f5f7fa;
    }
    body { font-family: "Kanit", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
    .container { max-width: 500px; margin: auto; background: #fff; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    h1 { text-align: center; color: var(--primary); font-size: 22px; margin-bottom: 5px; }
    .sub-title { text-align: center; color: #94a3b8; font-size: 14px; margin-bottom: 25px; }
    .round-tag { background: #e0f2fe; color: var(--primary); padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 14px; display: inline-block; margin-bottom: 15px; }
    
    #status-display { padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 20px; transition: 0.3s; }
    .status-idle { background: #f8fafc; color: #64748b; border: 2px dashed #e2e8f0; }
    .status-low { background: #fff9c4; color: #b45309; border: 2px solid #fef3c7; }
    .status-good { background: #f0fdf4; color: #15803d; border: 2px solid #dcfce7; }
    .status-high { background: #fef2f2; color: #b91c1c; border: 2px solid #fee2e2; }

    .value-display { font-size: 56px; font-weight: 700; line-height: 1; margin: 10px 0; }
    .timer-display { font-size: 16px; font-weight: 500; color: #64748b; margin-top: 5px; }
    canvas { width: 100%; height: 100px; border-radius: 15px; background: #fdfdfd; margin: 15px 0; }

    button { width: 100%; padding: 15px; border-radius: 15px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-bottom: 10px; }
    .btn-start { background: var(--primary); color: white; }
    .btn-stop { background: var(--danger); color: white; }
    .btn-outline { background: #f1f5f9; color: #64748b; }
    
    .input-group { margin-bottom: 15px; text-align: left; }
    input, select { width: 100%; padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 12px; box-sizing: border-box; font-family: 'Kanit'; }
    .hidden { display: none; }
    hr { border: 0; border-top: 1px solid #eee; margin: 15px 0; }
  </style>
</head>
<body>

<div class="container" id="page1">
    <center><img width="80px" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR6dh1EFfBVQyfw8WKTTaaqjwzfRXWzLyL6yw&s" alt="Logo"></center>
    <h1>Health Sensor App</h1>
    <div class="sub-title">‡∏ä‡∏°‡∏£‡∏°‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏ô‡∏ô‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏™‡∏£‡∏£‡∏Ñ‡πå</div>
    <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label><input id="name" type="text" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠"></div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div class="input-group"><label>‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label><input id="age" type="number"></div>
        <div class="input-group"><label>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label><input id="height" type="number"></div>
    </div>
    <div class="input-group"><label>‡πÄ‡∏û‡∏®</label><select id="gender"><option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option><option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
    <button class="btn-start" onclick="initMicAndNextPage()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö üöÄ</button>
</div>

<div class="container hidden" id="page2" style="text-align: center;">
    <div class="round-tag">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="roundNo">1</span> / 5</div>
    <div id="status-display" class="status-idle">
        <div id="status-text" style="font-size: 18px; font-weight: 600;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
        <div class="value-display"><span id="val-num">0</span> <span style="font-size:16px">L/min</span></div>
        <div class="timer-display">‚è± ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πà‡∏≤: <span id="current-timer">0.00</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
    </div>
    <canvas id="graphCanvas"></canvas>
    <button id="startBtn" class="btn-start" onclick="startTestRound()">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πà‡∏≤‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</button>
    <button id="stopBtn" class="btn-stop hidden" onclick="stopTestRound()">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î</button>
    <button class="btn-outline" style="font-size: 14px;" onclick="location.reload()">üîô ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
</div>

<div class="container hidden" id="page3" style="text-align: center;">
    <h1>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</h1>
    <div id="summary-data" style="background:#f8fafc; padding:20px; border-radius:20px; margin:20px 0; text-align:left; font-size: 15px;"></div>
    
    <div id="final-card" style="padding:25px; border-radius:20px; margin-bottom:20px; border: 1px solid #eee;">
        <div style="font-size: 14px; opacity: 0.8;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: <span id="final-avg-val">0</span> L/min</div>
        <div id="final-avg-duration" style="font-size:14px; opacity: 0.8; margin-bottom:10px;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: 0.00 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
        <div id="final-status" style="font-size:24px; font-weight:700; border-top: 1px solid rgba(0,0,0,0.1); padding-top:15px; margin-top:10px;"></div>
    </div>

    <button class="btn-start" onclick="window.print()">üíæ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (PDF)</button>
    <button class="btn-outline" onclick="location.reload()">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
</div>

<script>
    let user = {}, round = 0, allRounds = [], allDurations = [], isMeasuring = false;
    let audioContext, analyser, microphone, dataArray, animationId, globalStream;
    let silenceTimer, currentRoundMax = 0, startTime = 0, roundDuration = 0;

    function getPredictedPEFR(age, height, gender) {
        if (gender === '‡∏ä‡∏≤‡∏¢') {
            return Math.round(((height / 100) * 5.48) + (age * 0.03) - 0.42 * 60);
        } else {
            return Math.round(((height / 100) * 3.72) + (age * 0.03) - 0.42 * 60);
        }
    }

    async function initMicAndNextPage() {
        const n = document.getElementById('name').value;
        const a = document.getElementById('age').value;
        const h = document.getElementById('height').value;
        const g = document.getElementById('gender').value;
        if (!n || !a || !h || !g) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
        try {
            globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            user = { name: n, age: parseInt(a), height: parseInt(h), gender: g };
            user.predicted = getPredictedPEFR(user.age, user.height, user.gender);
            document.getElementById('page1').classList.add('hidden');
            document.getElementById('page2').classList.remove('hidden');
        } catch (e) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô'); }
    }

    async function startTestRound() {
        if (round >= 5) return;
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(globalStream);
            analyser.fftSize = 512;
            analyser.smoothingTimeConstant = 0.8;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            microphone.connect(analyser);
        }
        if (audioContext.state === 'suspended') await audioContext.resume();
        round++;
        currentRoundMax = 0; roundDuration = 0; startTime = 0;
        document.getElementById('roundNo').textContent = round;
        document.getElementById('startBtn').classList.add('hidden');
        document.getElementById('stopBtn').classList.remove('hidden');
        document.getElementById('current-timer').textContent = "0.00";
        isMeasuring = true;
        runLoop();
    }

    function runLoop() {
        const canvas = document.getElementById('graphCanvas');
        const ctx = canvas.getContext('2d');
        const statusDisplay = document.getElementById('status-display');
        const statusText = document.getElementById('status-text');

        function draw() {
            if (!isMeasuring) return;
            analyser.getByteFrequencyData(dataArray);
            let avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
            let pefr = Math.min(800, avg * 8.5); 
            
            if (pefr > 40) {
                if (startTime === 0) startTime = Date.now();
                roundDuration = (Date.now() - startTime) / 1000;
                document.getElementById('current-timer').textContent = roundDuration.toFixed(2);
                if (pefr > currentRoundMax) currentRoundMax = pefr;
                clearTimeout(silenceTimer);
                silenceTimer = setTimeout(stopTestRound, 1500);
            }

            document.getElementById('val-num').textContent = Math.round(pefr);
            if (pefr > 400) { statusDisplay.className = "status-good"; statusText.textContent = "‡πÄ‡∏õ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠!"; }
            else if (pefr > 40) { statusDisplay.className = "status-low"; statusText.textContent = "‡πÄ‡∏õ‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ..."; }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#1976d2';
            ctx.fillRect(0, canvas.height, canvas.width, -(pefr/800 * canvas.height));
            animationId = requestAnimationFrame(draw);
        }
        draw();
    }

    function stopTestRound() {
        isMeasuring = false;
        clearTimeout(silenceTimer);
        cancelAnimationFrame(animationId);
        allRounds.push(currentRoundMax);
        allDurations.push(roundDuration);
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('status-display').className = "status-idle";
        document.getElementById('status-text').textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà " + round + " ‡πÅ‡∏•‡πâ‡∏ß";
        if (round >= 5) setTimeout(showFinal, 800);
    }

    function showFinal() {
        document.getElementById('page2').classList.add('hidden');
        document.getElementById('page3').classList.remove('hidden');
        const avgPefr = allRounds.reduce((a, b) => a + b, 0) / allRounds.length;
        const avgDur = allDurations.reduce((a, b) => a + b, 0) / allDurations.length;
        const ratio = (avgPefr / user.predicted) * 100; // ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå

        document.getElementById('summary-data').innerHTML = `
            <b>‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</b> ${user.name}<br>
            <b>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô:</b> ${user.predicted} L/min<br><hr>
            ${allRounds.map((v, i) => `‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${i+1}: <b>${Math.round(v)}</b> L/min (‡πÄ‡∏ß‡∏•‡∏≤ ${allDurations[i].toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`).join('<br>')}
        `;

        document.getElementById('final-avg-val').textContent = Math.round(avgPefr);
        document.getElementById('final-avg-duration').textContent = `‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${avgDur.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        
        const st = document.getElementById('final-status');
        const card = document.getElementById('final-card');

        // Logic ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ‡πÅ‡∏î‡∏á 0-30, ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á 35-50, ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß 55 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
        if (ratio >= 55) {
            st.textContent = "‡∏õ‡∏Å‡∏ï‡∏¥ (Green Zone) üü¢";
            card.style.background = "#dcfce7"; card.style.color = "#15803d";
        } else if (ratio >= 35) {
            st.textContent = "‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á (Yellow Zone) üü°";
            card.style.background = "#fef3c7"; card.style.color = "#b45309";
        } else {
            st.textContent = "‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå (Red Zone) üî¥";
            card.style.background = "#fee2e2"; card.style.color = "#b91c1c";
        }
    }
</script>
</body>
</html>